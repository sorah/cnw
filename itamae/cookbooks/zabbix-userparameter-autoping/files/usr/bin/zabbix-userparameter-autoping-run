#!/usr/bin/env ruby
require 'fileutils'
require 'json'

system(*%w(ip route get 2001:4860:4860::8888), out: File::NULL, err: File::NULL)
v6 = $?.success?


dests = JSON.parse(File.read('/etc/autoping.json'))

ths = []
dests.each do |dest|
  next if dest['v6'] && !v6
  th = Thread.new do 
    v6 = dest['v6']
    cmd = ['zabbix-userparameter-autoping', v6 ? '-6' : nil, dest.fetch('host'), err: [:child, :out]].compact

    loop do
      t = Time.now
      log = IO.popen(cmd, 'r', &:read)
      unless $?.success?
        $stderr.puts "! #{dest.inspect} failed (#{$?.inspect}):"
        $stderr.puts log
      end
      e = Time.now
      i = [60-(e-t),0].max
      sleep i + rand(30)
    end
  end
  th.abort_on_exception = true
  ths << th
end
ths.each(&:join)
